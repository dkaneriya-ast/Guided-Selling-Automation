name: Robot Framework Tests

on:
  workflow_dispatch:
    inputs:
      suite:
        description: "Robot test suite to run (e.g., Tests/GuidedSellingFlow.robot)"
        required: true
        default: "Tests/GuidedSellingFlow.robot"
      env:
        description: "Environment to run against (dev/stg/prod)"
        required: true
        default: "dev"
      rerun:
        description: "Enable rerun of failed tests? (true/false)"
        required: false
        default: "true"

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Detect CPU cores
        id: cpu
        run: |
          cores=$(nproc)
          echo "Detected CPU cores: $cores"
          echo "cores=$cores" >> $GITHUB_OUTPUT

      - name: Run tests with rerun logic
        run: |
          echo "▶️ Running initial pabot tests..."
          if ! pabot --processes ${{ steps.cpu.outputs.cores }} --testlevelsplit \
              --variable env:${{ github.event.inputs.env }} \
              --outputdir Results \
              ${{ github.event.inputs.suite }}; then
              
              if [[ "${{ github.event.inputs.rerun }}" == "true" && -f Results/output.xml ]]; then
                  mkdir -p Results Results/rerun
                  echo "🔁 Initial run failed — rerunning failed tests..."
                  pabot --processes ${{ steps.cpu.outputs.cores }} --testlevelsplit \
                      --variable env:${{ github.event.inputs.env }} \
                      --prerunmodifier DataDriver.rerunfailed:Results/output.xml \
                      --outputdir Results/rerun \
                      --output rerun.xml \
                      --log rerun_log.html \
                      --report rerun_report.html \
                      ${{ github.event.inputs.suite }} || true

                  if [ -f Results/rerun/rerun.xml ]; then
                      echo "📊 Merging results..."
                      rebot --outputdir Results \
                          --log Results/merged_log.html \
                          --report Results/merged_report.html \
                          --output Results/merged_output.xml \
                          --merge Results/output.xml Results/rerun/rerun.xml
                  else
                      echo "⚠️ No rerun.xml produced. Skipping merge."
                  fi
              else
                  echo "⚠️ Rerun disabled or output.xml missing. Skipping rerun."
              fi
          fi

          echo "✅ Script execution completed"

      - name: Upload Robot Results
        uses: actions/upload-artifact@v4
        with:
          name: robot-results
          path: Results/
          retention-days: 7
