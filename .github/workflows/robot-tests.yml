name: Robot Framework Tests
on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment to run against (dev/stg/prod)"
        required: true
        default: "dev"
      rerun:
        description: "Enable rerun of failed tests? (true/false)"
        required: false
        default: "true"
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Detect CPU cores
        id: cpu
        run: |
          cores=$(nproc)
          echo "cores=$cores" >> $GITHUB_OUTPUT
      - name: Run initial Robot tests
        run: |
          echo ":arrow_forward: Running initial pabot tests..."
          pabot --processes ${{ steps.cpu.outputs.cores }} --testlevelsplit \
                --variable env:${{ github.event.inputs.env }} \
                --outputdir Results \
                Tests/GuidedSellingFlow.robot || echo "INITIAL_FAILED=true" >> $GITHUB_ENV
      - name: Rerun failed tests (if any)
        if: ${{ env.INITIAL_FAILED == 'true' && github.event.inputs.rerun == 'true' }}
        run: |
          echo ":repeat: Rerunning failed tests..."
          mkdir -p Results/rerun
          pabot --processes ${{ steps.cpu.outputs.cores }} --testlevelsplit \
                --variable env:${{ github.event.inputs.env }} \
                --prerunmodifier DataDriver.rerunfailed:Results/output.xml \
                --outputdir Results/rerun \
                --output rerun.xml \
                --log rerun_log.html \
                --report rerun_report.html \
                --runemptysuite \
                Tests/GuidedSellingFlow.robot || true
          if [ -f Results/rerun/rerun.xml ]; then
              echo ":bar_chart: Merging results..."
              rebot --outputdir Results \
                    --log Results/merged_log.html \
                    --report Results/merged_report.html \
                    --output Results/merged_output.xml \
                    --merge Results/output.xml Results/rerun/rerun.xml
          else
              echo ":warning: No rerun.xml produced. Skipping merge."
          fi
      - name: Upload Robot Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-results
          path: Results/
          retention-days: 7
