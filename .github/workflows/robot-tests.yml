name: Robot Framework Tests (Two-Job Retry)

on:
  workflow_dispatch:
    inputs:
      suite:
        description: "Robot test suite to run"
        required: true
        default: "Tests/GuidedSellingFlow.robot"
      rerun:
        description: "Allow rerunning failed tests? (true/false)"
        required: false
        default: "true"
      env:
        description: "Environment to run against (dev/stg/prod)"
        required: true
        default: "dev"

jobs:
  # =================================================================
  # JOB 1: Run the tests for the first time
  # =================================================================
  initial-run:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check_failures.outputs.status }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Detect CPU cores
        id: cpu
        run: |
          cores=$(nproc)
          echo "Detected CPU cores: $cores"
          echo "cores=$cores" >> $GITHUB_OUTPUT

      - name: Prepare Results folder
        run: |
          mkdir -p "$GITHUB_WORKSPACE/Results"
          rm -f "$GITHUB_WORKSPACE/Results/results.xlsx"
          
      - name: Run Robot tests with pabot
        id: run_tests
        continue-on-error: true
        run: |
          pabot --processes ${{ steps.cpu.outputs.cores }} --testlevelsplit \
            --variable env:${{ github.event.inputs.env }} \
            --outputdir Results \
            ${{ github.event.inputs.suite }}

      - name: Check for failures and set job output
        id: check_failures
        run: |
          # Ensure this step never fails, always sets status
          if rebot --nostatusrc Results/output.xml; then
            echo "Initial run passed."
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "Initial run has failures."
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Upload original results artifact
        if: steps.check_failures.outputs.status == 'failed'
        uses: actions/upload-artifact@v4
        with:
          name: original-robot-results
          path: Results/
          retention-days: 1

  # =================================================================
  # JOB 2: Rerun failed tests (only if Job 1 failed)
  # =================================================================
  rerun-failed:
    runs-on: ubuntu-latest
    needs: initial-run
    # safer condition: rerun unless explicitly "false"
    if: needs.initial-run.outputs.status == 'failed' && github.event.inputs.rerun != 'false'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Detect CPU cores
        id: cpu
        run: |
          cores=$(nproc)
          echo "Detected CPU cores: $cores"
          echo "cores=$cores" >> $GITHUB_OUTPUT

      - name: Download original results artifact
        uses: actions/download-artifact@v4
        with:
          name: original-robot-results
          path: Results

      - name: Rerun failed tests with pabot
        run: |
          echo "ğŸ” Rerunning failed tests..."
          mkdir -p Results/rerun
          pabot --processes ${{ steps.cpu.outputs.cores }} --testlevelsplit \
            --variable env:${{ github.event.inputs.env }} \
            --prerunmodifier DataDriver.rerunfailed:Results/output.xml \
            --outputdir Results/rerun \
            --output rerun.xml \
            ${{ github.event.inputs.suite }}

      - name: Merge and Finalize Results
        run: |
          echo "Merging original and rerun results..."
          rebot --outputdir Results \
            --output final_output.xml \
            --log final_log.html \
            --report final_report.html \
            --merge Results/output.xml Results/rerun/rerun.xml

      - name: Upload Final Merged Results
        uses: actions/upload-artifact@v4
        with:
          name: final-robot-results
          path: |
            Results/final_report.html
            Results/final_log.html
            Results/final_output.xml
          retention-days: 7

  # =================================================================
  # JOB 3: Final gatekeeper job to determine overall status
  # =================================================================
  final-status-check:
    runs-on: ubuntu-latest
    needs: [initial-run, rerun-failed]
    if: always()

    steps:
      - name: Evaluate final status
        run: |
          echo "Initial run status: ${{ needs.initial-run.outputs.status }}"
          echo "Rerun job status: ${{ needs.rerun-failed.result }}"

          if [ "${{ needs.initial-run.outputs.status }}" == "passed" ]; then
            echo "âœ… All tests passed on the first run. Workflow is successful."
            exit 0
          fi

          if [ "${{ github.event.inputs.rerun }}" == "false" ]; then
            echo "âŒ Tests failed and rerun was disabled. Workflow has failed."
            exit 1
          fi

          if [ "${{ needs.rerun-failed.result }}" == "success" ]; then
            echo "âœ… Tests failed initially but passed after rerun. Workflow is successful."
            exit 0
          fi

          if [ "${{ needs.rerun-failed.result }}" == "failure" ]; then
            echo "âŒ Tests still failed after rerun. Workflow has failed."
            exit 1
          fi

          echo "âš ï¸ Unexpected state: rerun job skipped or missing. Treating as failure."
          exit 1
