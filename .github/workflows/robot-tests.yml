name: Trigger Robot Tests Manually

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment to run against (dev/stg/prod)"
        required: true
        default: "dev"
      rerun:
        description: "Enable rerun of failed tests? (true/false)"
        required: false
        default: "true"

jobs:
  run_tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Clear Reports directory
        run: |
          echo "üßπ Cleaning Reports directory..."
          rm -rf Reports/*
          mkdir -p Reports

      - name: Run Robot Framework Tests (Initial)
        id: initial
        run: |
          echo "‚ñ∂Ô∏è Running initial Robot tests..."
          docker run \
            -v ${PWD}/Reports:/opt/robotframework/reports:Z \
            -v ${PWD}/Tests:/opt/robotframework/tests:Z \
            -e ROBOT_OPTIONS="--variable env:${{ github.event.inputs.env }} /opt/robotframework/tests/GuidedSellingFlow.robot" \
            --user $(id -u):$(id -g) \
            ppodgorsek/robot-framework:latest || echo "INITIAL_FAILED=true" >> $GITHUB_ENV

      - name: Rerun failed tests (if enabled)
        if: ${{ env.INITIAL_FAILED == 'true' && github.event.inputs.rerun == 'true' }}
        run: |
          echo "üîÅ Rerunning failed tests..."
          mkdir -p Reports/rerun
          docker run \
            -v ${PWD}/Reports:/opt/robotframework/reports:Z \
            -v ${PWD}/Tests:/opt/robotframework/tests:Z \
            -e ROBOT_OPTIONS="--variable env:${{ github.event.inputs.env }} --prerunmodifier DataDriver.rerunfailed:/opt/robotframework/reports/output.xml --outputdir /opt/robotframework/reports/rerun --output rerun.xml --log rerun_log.html --report rerun_report.html --runemptysuite /opt/robotframework/tests/GuidedSellingFlow.robot" \
            --user $(id -u):$(id -g) \
            ppodgorsek/robot-framework:latest || true

          if [ -f Reports/rerun/rerun.xml ]; then
            echo "üìä Merging results..."
            docker run \
              -v ${PWD}/Reports:/opt/robotframework/reports:Z \
              -v ${PWD}/Tests:/opt/robotframework/tests:Z \
              -e ROBOT_OPTIONS="--outputdir /opt/robotframework/reports --log merged_log.html --report merged_report.html --output merged_output.xml --merge /opt/robotframework/reports/output.xml /opt/robotframework/reports/rerun/rerun.xml" \
              --user $(id -u):$(id -g) \
              ppodgorsek/robot-framework:latest
          else
            echo "‚ö†Ô∏è No rerun.xml produced. Skipping merge."
          fi

      - name: Upload reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: robot-reports
          path: Reports/
          retention-days: 7
