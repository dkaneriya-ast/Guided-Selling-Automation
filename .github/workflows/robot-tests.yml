name: Robot Framework Tests
on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment to run against (dev/stg/prod)"
        required: true
        default: "dev"
      rerun:
        description: "Enable rerun of failed tests?"
        required: true
        type: boolean
        default: true
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install robotframework-pabot==4.2.0
          
      - name: Check Package Versions
        run: |
          echo "pabot version:"
          pabot --version
          echo "---"
          echo "DataDriver version:"
          pip show robotframework-datadriver

      - name: Detect CPU cores
        id: cpu
        run: echo "cores=$(nproc)" >> $GITHUB_OUTPUT

      - name: Run initial Robot tests
        id: initial_run
        continue-on-error: true
        run: |
          echo "‚û°Ô∏è Running initial pabot tests..."
          pabot --processes ${{ steps.cpu.outputs.cores }} \
                --testlevelsplit \
                --variable env:${{ github.event.inputs.env }} \
                --outputdir Results \
                Tests/GuidedSellingFlow.robot

      - name: Rerun failed tests and Merge Results
        if: steps.initial_run.outcome == 'failure' && github.event.inputs.rerun == 'true'
        run: |
          echo "üîÅ Rerunning failed tests..."
          # Use '|| true' so this step doesn't fail if tests still fail, allowing the merge to proceed
          pabot --processes ${{ steps.cpu.outputs.cores }} \
                --testlevelsplit \
                --variable env:${{ github.event.inputs.env }} \
                --prerunmodifier DataDriver.rerunfailed:Results/output.xml \
                --outputdir Results/rerun \
                --output rerun.xml \
                Tests/GuidedSellingFlow.robot || true
          
          if [ -f Results/rerun/rerun.xml ]; then
            echo "üìä Merging results..."
            # Rebot's exit code will determine the final status of the job.
            rebot --outputdir Results \
                  --merge Results/output.xml Results/rerun/rerun.xml \
                  --output merged_output.xml \
                  --log merged_log.html \
                  --report merged_report.html
          else
            echo "‚ö†Ô∏è No rerun.xml was produced. The initial failure will stand."
            exit 1 # Explicitly fail the job if the rerun produced no output
          fi

      - name: Check initial run status
        if: steps.initial_run.outcome == 'failure' && github.event.inputs.rerun == 'false'
        run: |
          echo "::error::Initial tests failed and reruns were disabled. Failing the workflow."
          exit 1
          
      - name: Upload Robot Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-results-${{ github.event.inputs.env }}
          path: Results/
          retention-days: 7
