name: Robot Framework Tests

on:
  workflow_dispatch:
    inputs:
      suite:
        description: "Robot test suite to run (e.g., Tests/GuidedSellingFlow.robot)"
        required: true
        default: "Tests/GuidedSellingFlow.robot"
      rerun:
        description: "Rerun failed tests? (true/false)"
        required: false
        default: "true"
      env:
        description: "Environment to run against (dev/stg/prod)"
        required: true
        default: "dev"

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      ROBOT_WORKSPACE: ${{ github.workspace }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare Results folder
        run: |
          rm -rf "$ROBOT_WORKSPACE/Results"
          mkdir -p "$ROBOT_WORKSPACE/Results"

      - name: Initial test run with pabot
        id: initial_run
        # This allows the workflow to continue to the rerun step upon failure
        continue-on-error: true
        run: |
          pabot --testlevelsplit \
            --variable env:${{ github.event.inputs.env }} \
            --outputdir "$ROBOT_WORKSPACE/Results" \
            ${{ github.event.inputs.suite }}

      - name: Rerun failed tests (if any)
        # FIXED: Use the step's 'outcome' for reliable failure detection
        if: steps.initial_run.outcome == 'failure' && github.event.inputs.rerun == 'true'
        run: |
          echo "üîÅ Rerunning failed tests..."
          if [ ! -f "$ROBOT_WORKSPACE/Results/output.xml" ]; then
            echo "‚ùå output.xml not found, cannot rerun."
            exit 0
          fi
          
          # Added --processes and --testlevelsplit for parallel execution
          pabot --rerunfailed "$ROBOT_WORKSPACE/Results/output.xml" \
            --processes ${{ steps.cpu.outputs.cores }} \
            --testlevelsplit \
            --variable env:${{ github.event.inputs.env }} \
            --outputdir "$ROBOT_WORKSPACE/Results/rerun" \
            --output rerun.xml
            
      - name: Merge and Finalize Results
        # This step always runs to ensure results are processed
        if: always()
        run: |
          # If a rerun happened, merge the results into final files
          if [ -f "$ROBOT_WORKSPACE/Results/rerun/rerun.xml" ]; then
            echo "Merging original and rerun results..."
            rebot --outputdir "$ROBOT_WORKSPACE/Results" \
              --output final_output.xml \
              --log final_log.html \
              --report final_report.html \
              --merge "$ROBOT_WORKSPACE/Results/output.xml" "$ROBOT_WORKSPACE/Results/rerun/rerun.xml"
          # Otherwise, rename the original results to the final names for consistency
          elif [ -f "$ROBOT_WORKSPACE/Results/output.xml" ]; then
            echo "No rerun occurred. Finalizing original results."
            mv "$ROBOT_WORKSPACE/Results/output.xml" "$ROBOT_WORKSPACE/Results/final_output.xml"
            mv "$ROBOT_WORKSPACE/Results/log.html" "$ROBOT_WORKSPACE/Results/final_log.html"
            mv "$ROBOT_WORKSPACE/Results/report.html" "$ROBOT_WORKSPACE/Results/final_report.html"
          fi

      - name: Check final test status
        # This step ensures the entire workflow fails if tests are still failing
        if: always()
        run: |
          if [ -f "$ROBOT_WORKSPACE/Results/final_output.xml" ]; then
            echo "Checking final results for failures..."
            # --nostatusrc tells rebot to exit with an error code if any tests failed
            rebot --nostatusrc "$ROBOT_WORKSPACE/Results/final_output.xml"
          elif [ "${{ steps.initial_run.outcome }}" == "failure" ]; then
             echo "::error::Initial test run failed and no results were generated to check."
             exit 1
          fi

      - name: Upload Final Robot Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-final-results
          # Upload only the final, clean artifacts
          path: |
            Results/final_report.html
            Results/final_log.html
            Results/final_output.xml
          if-no-files-found: warn # Prevents errors if results generation failed
          retention-days: 7
